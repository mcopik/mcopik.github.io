<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Processing mixed operands and arguments with getopts</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2017/processing-mixed-operands-and-arguments-with-getopts/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Processing mixed operands and arguments with getopts</h1>
    <p class="post-meta">January 28, 2017</p>
  </header>

  <article class="post-content">
    <p>There are different ways of parsing arguments in Bash and choosing between GNU getopt and POSIX <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/getopts.html">getopts</a> is almost a religious issue, just like any other problem in Computer Science with more than one applicable solution. Some time ago I have discovered a simple yet interesting issue which neither of those tools is able to solve: mixing positional parameters with operands. I was surprised to find out that there is a very simple solution which seems to not be widely known. Although you can find this small tip, a <a href="http://stackoverflow.com/questions/11742996/shell-script-is-mixing-getopts-with-positional-parameters-possible">SO question</a> on exactly that problem has few not helpful answers and a real solution is either hidden in comments or at the very bottom.</p>

<p><a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap12.html">The POSIX specification</a> and guideline 9 suggest that an argument syntax should consist of a finite list of arguments followed by a finite list of operands, i.e. arguments following the last option. Sometimes we would like to abuse the syntax and insert multiple operands between options. A perfect example are build commands generated by CMake which tends to create a mix of source files or translation units, libraries to link, compilation and linking flags.</p>

<p>Of course it wouldnâ€™t work directly with getopts and thatâ€™s why I have been so surprised to see it being used in a shell script which is supposed to be a wrapper invoking three different stages of building an executable. Getopts stops processing a stream of arguments as soon as first operand appears and there is no way to configure it to ignore or gather unrecognized options. You can see the problem in listing below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while </span><span class="nb">getopts</span> &lt;options_here&gt; opt<span class="p">;</span> <span class="k">do
	case</span> <span class="s2">"</span><span class="nv">$opt</span><span class="s2">"</span> <span class="k">in</span>
		&lt;process options&gt;
	esace
<span class="k">done</span>
</code></pre></div></div>

<p>A loop processes recognized options as long as getopts do not fail. Letâ€™s leave it like that and focus on getting the operand. <a href="http://pubs.opengroup.org/onlinepubs/7908799/xcu/getopts.html"><code class="language-plaintext highlighter-rouge">OPTIND</code></a> contains the index of the next argument to be processed. The easiest way here is to remove all already processed options by using <a href="http://www.tldp.org/LDP/Bash-Beginners-Guide/html/sect_09_07.html"><code class="language-plaintext highlighter-rouge">shift</code></a>. We want to remove <code class="language-plaintext highlighter-rouge">OPTIND -1</code> strings to be able to access the operand as first argument <code class="language-plaintext highlighter-rouge">$1</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">FILES</span><span class="o">=</span><span class="s2">""</span>
<span class="k">while </span><span class="nb">getopts</span> &lt;options_here&gt; opt<span class="p">;</span> <span class="k">do
	case</span> <span class="s2">"</span><span class="nv">$opt</span><span class="s2">"</span> <span class="k">in</span>
		&lt;process options&gt;
	esace
<span class="k">done
</span><span class="nb">shift</span> <span class="s2">"</span><span class="k">$((</span>OPTIND-1<span class="k">))</span><span class="s2">"</span>
<span class="nv">FILES</span><span class="o">=</span><span class="s2">"</span><span class="nv">$FILES</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span>
</code></pre></div></div>
<p>The pattern above is rather known, at least on <a href="http://unix.stackexchange.com/questions/214141/explain-the-shell-command-shift-optind-1/214151">Unix Stack Exchange</a>. To finally solve the problem we only need one more loop in which each iteration processes as many options as possible and saves the operand breaking getopts loop.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">FILES</span><span class="o">=</span><span class="s2">""</span>
<span class="k">while</span> <span class="o">[</span><span class="nv">$# </span><span class="nt">-gt</span> 0]<span class="p">;</span> <span class="k">do</span>
	<span class="c">#necessary!</span>
	<span class="nv">OPTIND</span><span class="o">=</span>1
	<span class="k">while </span><span class="nb">getopts</span> &lt;options_here&gt; opt<span class="p">;</span> <span class="k">do
		case</span> <span class="s2">"</span><span class="nv">$opt</span><span class="s2">"</span> <span class="k">in</span>
			&lt;process options&gt;
		esace
	<span class="k">done</span>
	<span class="c">#remove already processed arguments</span>
	<span class="nb">shift</span> <span class="s2">"</span><span class="k">$((</span>OPTIND-1<span class="k">))</span><span class="s2">"</span>
	<span class="c">#access operand</span>
	<span class="nv">FILES</span><span class="o">=</span><span class="s2">"</span><span class="nv">$FILES</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span>
	<span class="c">#remove operand</span>
	<span class="nb">shift
</span><span class="k">done</span>
</code></pre></div></div>

<p>This loop iterates until all arguments are processed; accessing remaining arguments with <code class="language-plaintext highlighter-rouge">$@</code> is unnecessary. A crucial component is here to restart the index in each outer loop iteration. Otherwise getopts would start processing at a wrong position and it would skip a lot of valuable information.</p>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
