<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Implicit function prototypes are evil.</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2019/cffi-pointers/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Implicit function prototypes are evil.</h1>
    <p class="post-meta">December 18, 2019</p>
  </header>

  <article class="post-content">
    <p>Recently I stumbled upon a major issue when using the <a href="https://cffi.readthedocs.io/en/latest/">cffi</a>
library to pass data generated inside C library to Python. The following code
was supposed to access pointers and lengths of arrays from the C library
and make the data available for further processing in Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">count</span> <span class="o">=</span> <span class="n">lib</span><span class="p">.</span><span class="n">overflow_buffer_count</span><span class="p">();</span>                                        
<span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                                                               
    <span class="n">buf_size</span> <span class="o">=</span> <span class="n">lib</span><span class="p">.</span><span class="n">overflow_buffer_size</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>                                 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>                                           
        <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffi</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">lib</span><span class="p">.</span><span class="n">overflow_buffer_access</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">buf_size</span><span class="p">))</span>    
    <span class="c1"># last buffer might not be full                                         
</span>    <span class="n">buf_size</span> <span class="o">=</span> <span class="n">lib</span><span class="p">.</span><span class="n">overflow_buffer_size</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                          
    <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffi</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">lib</span><span class="p">.</span><span class="n">overflow_buffer_access</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">buf_size</span><span class="p">))</span>
</code></pre></div></div>

<p>This code would work until it wouldnâ€™t. On rare occasions, when the buffer length
is sufficiently large to create only a single allocation, the code would cause
a segmentation fault. Obviously, I tried to find the bug in the code handling
allocation of multiple buffers. Yet, it wasnâ€™t the reason behind incorrect
memory accesses. Finally, I was able to confirm that pointer values used in
C and Python code were different!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># C output
PYPAPI: Overflow buffer acccess 0x7f0c5af5e010 at 0
# Python output
&lt;cdata 'long long *' 0x5af5e010&gt;

# C output
PYPAPI: Overflow buffer acccess 0x7f25d19a9010 at 0
# Python output
&lt;cdata 'long long *' 0xffffffffd19a9010&gt;
</code></pre></div></div>

<p>The 64-bit pointer has been truncated to a 32-bit value! The bug would manifest
itself only when pointer returned from <code class="language-plaintext highlighter-rouge">malloc</code> was, in fact, a 64-bit value. The
question remained: why did it happen?</p>

<p>An inspection of the build process of C library allocating buffers revelead a couple
of warnings that are usually ignored as harmless.</p>

<blockquote>
  <p>pypapi/_papi.c:1939:10: warning: implicit declaration of function â€˜overflow_buffer_accessâ€™; did you mean â€˜_cffi_d_overflow_buffer_accessâ€™? [-Wimplicit-function-declaration]</p>
</blockquote>

<p>Clearly, the C bindings generated by <code class="language-plaintext highlighter-rouge">cffi</code> are missing the declaration of my
C function <code class="language-plaintext highlighter-rouge">overflow_buffer_access</code>. The problem lied deep in the build code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>                              
<span class="n">_PAPI_H</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">_ROOT</span><span class="p">,</span> <span class="s">"papi.h"</span><span class="p">)</span>                                         
<span class="n">_PAPI_CALLBACKS</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">_ROOT</span><span class="p">,</span> <span class="s">"papi_callbacks.h"</span><span class="p">)</span>                       
                                                                                
                                                                                
<span class="n">ffibuilder</span> <span class="o">=</span> <span class="n">FFI</span><span class="p">()</span>                                                              
<span class="n">ffibuilder</span><span class="p">.</span><span class="n">set_source</span><span class="p">(</span>                                                          
        <span class="s">"pypapi._papi"</span><span class="p">,</span>                                                         
        <span class="s">'#include "papi.h"'</span><span class="p">,</span>                       
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">'pypapi/papi_callbacks.c'</span><span class="p">],</span>                                    
        <span class="n">extra_objects</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">_ROOT</span><span class="p">,</span> <span class="s">".."</span><span class="p">,</span> <span class="s">"papi"</span><span class="p">,</span> <span class="s">"src"</span><span class="p">,</span> <span class="s">"libpapi.a"</span><span class="p">)],</span>  
        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">_ROOT</span><span class="p">],</span>                                                   
        <span class="p">)</span>                                                                       
<span class="n">ffibuilder</span><span class="p">.</span><span class="n">cdef</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">_PAPI_H</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>                                      
<span class="n">ffibuilder</span><span class="p">.</span><span class="n">cdef</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">_PAPI_CALLBACKS</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span> 
</code></pre></div></div>

<p>While we provide headers through a call to <code class="language-plaintext highlighter-rouge">cdef</code>, they are only used by <code class="language-plaintext highlighter-rouge">cffi</code>
to register C types for usage from Python code. The actual headers used for the compilation
of binding are provided in the second argument of a call to <code class="language-plaintext highlighter-rouge">set_source</code>. Due to
a small typo, I provided a proper include to <a href="https://icl.utk.edu/papi/">PAPI</a> used by my C library but
forgot the <code class="language-plaintext highlighter-rouge">#include "papi_callbacks.h"</code>. Adding the include resolved both
compiler warnings and the problem with pointer truncation.</p>

<p>But why did it cause the issue in the first place? The actual reason is the permissive
C allowing to use functions without providing its declaration, in contrast
to C++ rules that are much more strict there. Since the function declaration might
not available when processing the calling code, the compiler generates a prototype
applying a set of standard rules. The return type is not a part of function signature
and is by default assumed to be an <code class="language-plaintext highlighter-rouge">integer</code>. As we can find in the C89 standard
(<a href="http://port70.net/~nsz/c/c89/c89-draft.html#3.3.2.2">link to one of the drafts available online</a>,
the official standard release is still quite expensive even though the language is
30 years old).</p>
<blockquote>
  <p>If the expression that precedes the parenthesized argument list in a function call consists solely of an identifier, and if no declaration is visible for this identifier, the identifier is implicitly declared exactly as if, in the innermost block containing the function call, the declaration</p>
  <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         <span class="k">extern</span> <span class="kt">int</span>  <span class="nf">identifier</span><span class="p">();</span>
</code></pre></div>  </div>
  <p>appeared.</p>
</blockquote>

<p>With an implicit cast to integer, the mystery of pointer truncation is resolved.
Of course, <a href="https://stackoverflow.com/questions/30168044/how-to-support-64-bits-pointers-in-cffi">I wasnâ€™t the only one to cause such problems</a>.
After all, itâ€™s an easy mistake to make, and fortunately,
the implicit function declaration has been removed from C99 standard, although
the compiler is still allowed to create an implicit declaration for compatibility
reasons, as we find in <a href="http://www.open-std.org/jtc1/sc22/wg14/www/C99RationaleV5.10.pdf">the rationale for C99 standard</a>.</p>

<blockquote>
  <p>A new feature of C99: The rule for implicit declaration of functions has been removed in C99. The effect is to guarantee the production of a diagnostic that will catch an additional category of programming errors. After issuing the diagnostic, an implementation may choose to assume an implicit declaration and continue translation in order to support existing programs that exploited this feature.</p>
</blockquote>

<p>One more
reason to enable <code class="language-plaintext highlighter-rouge">-std=c99</code> switch in all C builds and of course, always pay
attention to compiler warnings!</p>


  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
