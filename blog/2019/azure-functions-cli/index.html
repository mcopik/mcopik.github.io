<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Azure CLI login in 2020</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2019/azure-functions-cli/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Azure CLI login in 2020</h1>
    <p class="post-meta">December 24, 2019</p>
  </header>

  <article class="post-content">
    <p>Azure provides a command-line tool to manage its cloud resources.
Itâ€™s an important tool when automatizing the deployment of our systems to Azure.
However, when compared to clouds such as AWS, thereâ€™s one caveat: <a href="https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli">the login method</a>.
While itâ€™s possible to log in with standard credentials, this method is disabled for most of the accounts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>This approach doesn't work with Microsoft accounts or
accounts that have two-factor authentication enabled.
</code></pre></div></div>

<p>Instead, if we run the standard <code class="language-plaintext highlighter-rouge">az login</code> command, weâ€™re going to see the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To sign in, use a web browser to open the page https://microsoft.com/devicelogin
and enter the code XXXXXXXX to authenticate.
</code></pre></div></div>

<p>And only after opening a browser, going to the dedicated website, weâ€™ll be able to authenticate the
CLI session, and weâ€™ll see the output confirming a successful login operation:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"cloudName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AzureCloud"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"homeTenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YYYYYY"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXXXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXXXXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">

</span></code></pre></div></div>

<p>Obviously, we canâ€™t rely on such method when building automatic deployment systems.
Instead, we can use <a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli#sign-in-using-a-service-principal">service principal</a> credentials to handle the login.
Fortunately, we can create this resource in a single step:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-5.1#</span><span class="w"> </span>az ad sp create-for-rbac <span class="nt">--name</span> <span class="k">${</span><span class="nv">principal_name</span><span class="k">}</span> <span class="nt">--only-show-errors</span>
<span class="go">{
  "appId": "XXX",
</span><span class="gp">  "displayName": "$</span><span class="o">{</span>principle_name<span class="o">}</span><span class="s2">",
</span><span class="go">  "name": "VVVVV",
  "password": "YYY",
  "tenant": "ZZZ"
}
</span></code></pre></div></div>

<p><strong>These values must be stored as they are non-retreviable</strong>.
Then, the standard non-interactive login method can be used:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">bash-5.1#</span><span class="w"> </span>az login <span class="nt">-u</span> XXX <span class="nt">--service-principal</span> <span class="nt">--tenant</span> ZZZ <span class="nt">-p</span> YYY
</code></pre></div></div>

<p>To make this process easy an intuitive for our users, we implemented
<a href="https://github.com/spcl/serverless-benchmarks/blob/master/tools/create_azure_credentials.py">a simple wrapper</a> in our
<a href="/projects/sebs">serverless benchmarking suite</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'Please provide the intended principal name'</span><span class="p">)</span>
<span class="n">principal_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="n">_</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">exec_run</span><span class="p">(</span><span class="s">"az login"</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Please follow the login instructions to generate credentials...'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">out</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="c1"># wait for login finish
</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">ret_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Loggin succesfull with user {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ret_json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'user'</span><span class="p">]))</span>
<span class="n">status</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">exec_run</span><span class="p">(</span><span class="s">"az ad sp create-for-rbac --name {} --only-show-errors"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">principal_name</span><span class="p">))</span>
<span class="k">if</span> <span class="n">status</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Unsuccesfull principal creation!'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Created service principal {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="s">'name'</span><span class="p">]))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'AZURE_SECRET_APPLICATION_ID = {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="s">'appId'</span><span class="p">]))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'AZURE_SECRET_TENANT = {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="s">'tenant'</span><span class="p">]))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'AZURE_SECRET_PASSWORD = {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="s">'password'</span><span class="p">]))</span>
</code></pre></div></div>

<p>The Azure CLI is insufficient to create and deploy serverless function apps - we need
<a href="https://github.com/Azure/azure-functions-core-tools/">Azure Functions Core Tools</a>, as explained
<a href="https://docs.microsoft.com/en-us/azure/azure-functions/create-first-function-cli-python">in the documentation</a>.</p>

<h2 id="docker-image">Docker image</h2>

<p>Running a Docker image with Azure CLI could simplify the entire process significantly - no relogging
needed, just spin an instance of the CLI in the background, keep it running, and execute cloud
management commands there.
Azure provides <a href="https://docs.microsoft.com/en-us/cli/azure/run-azure-cli-docker">a Docker image</a>
with the CLI installed.
However, it uses Alpine Linux as the base image - a common choice due to its small image size.
This can lead to a common problem of <code class="language-plaintext highlighter-rouge">libc</code> compatibility - Alpine uses <code class="language-plaintext highlighter-rouge">musl</code> as its implementation
of the C library. Itâ€™s great software, but itâ€™s not binary compatible with <code class="language-plaintext highlighter-rouge">libc</code>, as we discovered
when trying to use the Functions Core Tools:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.1# chmod +x func 
bash-5.1# ./func 
Error loading shared library ld-linux-x86-64.so.2: No such file or directory
(needed by ./func)
</code></pre></div></div>

<p>This issue can be solved by installing <code class="language-plaintext highlighter-rouge">libc6-compat</code> and <code class="language-plaintext highlighter-rouge">gcompat</code>, but in our case, it only leads to
further problems. Instead, we decided to create a new Docker image and install both tools there.
Additionally, we install Node.js to locally host and invoke JavaScript function apps.
<a href="https://github.com/MicrosoftDocs/azure-docs/issues/41512">We canâ€™t use Debian <code class="language-plaintext highlighter-rouge">buster</code></a>,
but Debian <code class="language-plaintext highlighter-rouge">stretch</code> should work.</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> python:3.7-slim-stretch</span>
<span class="k">ARG</span><span class="s"> USER</span>
<span class="c"># disable telemetry by default</span>
<span class="k">ENV</span><span class="s"> FUNCTIONS_CORE_TOOLS_TELEMETRY_OPTOUT=1</span>

<span class="k">RUN </span>apt-get clean <span class="o">&amp;&amp;</span> apt-get update<span class="se">\
</span>  <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> ca-certificates curl apt-transport-https<span class="se">\
</span>    lsb-release gnupg libicu57<span class="se">\
</span>  <span class="o">&amp;&amp;</span> curl <span class="nt">-sL</span> https://packages.microsoft.com/keys/microsoft.asc | gpg <span class="nt">--dearmor</span><span class="se">\
</span>    | <span class="nb">tee</span> /etc/apt/trusted.gpg.d/microsoft.asc.gpg <span class="o">&gt;</span> /dev/null<span class="se">\
</span>  <span class="o">&amp;&amp;</span> <span class="nv">AZ_REPO</span><span class="o">=</span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="se">\
</span>  <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ </span><span class="nv">$AZ_REPO</span><span class="s2"> main"</span><span class="se">\
</span>    | <span class="nb">tee</span> /etc/apt/sources.list.d/azure-cli.list<span class="se">\
</span>  <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"deb [arch=amd64] https://packages.microsoft.com/debian/9/prod </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> main"</span> <span class="o">&gt;</span> /etc/apt/sources.list.d/dotnetdev.list<span class="se">\
</span>  <span class="o">&amp;&amp;</span> apt-get update<span class="se">\
</span>  <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> azure-cli azure-functions-core-tools-3<span class="se">\
</span>  <span class="c"># Install NodeJS 10.x to test functions locally with func host</span>
  &amp;&amp; curl -sL https://deb.nodesource.com/setup_10.x | bash - &amp;&amp; apt-get install -y nodejs\
  &amp;&amp; apt-get purge -y --auto-remove curl lsb-release gnupg

<span class="k">ENV</span><span class="s"> HOME=/home/${USER}</span>
<span class="k">RUN </span>useradd <span class="nt">--uid</span> 1000 <span class="nt">-m</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>:<span class="k">${</span><span class="nv">USER</span><span class="k">}</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>:<span class="k">${</span><span class="nv">USER</span><span class="k">}</span> /mnt
<span class="k">WORKDIR</span><span class="s"> ${HOME}</span>
<span class="k">USER</span><span class="s"> ${USER}:${USER}</span>

<span class="c"># Extension must be installed for a specific user, I guess.</span>
<span class="c"># Installed with root does not work for user.</span>
<span class="k">RUN </span>az extension add <span class="nt">--name</span> application-insights
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">FUNCTIONS_CORE_TOOLS_TELEMETRY_OPTOUT=1</code> environment variable is used to opt-out of the telemetry
system, and we install additional extensions to easily query performance metrics - these will be
discussed in an upcoming blogpost.</p>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
