<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Measuring Azure Functions performance</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2020/azure-functions-monitoring/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Measuring Azure Functions performance</h1>
    <p class="post-meta">January 20, 2020</p>
  </header>

  <article class="post-content">
    <p>Some time ago, I wrote <a href="https://mcopik.github.io/serverless/2019/12/24/aws-lambda-durations/">a short note</a>
on measuring serverless functions durations and memory consumption on AWS Lambda.
This time we will take a look at Azure Functions, where the situation
is a bit more complicated. Microsoft serverless offerings do not offer a similar
level of comfort since the function response does not involve any information
on function execution. For that purpose, we need to query logs using <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview">Azure
Application Insights</a>.</p>

<p>We can access Application Insights using <a href="https://docs.microsoft.com/en-us/cli/azure/ext/application-insights/monitor/app-insights/events?view=azure-cli-latest">CLI</a> and a <a href="https://dev.applicationinsights.io/quickstart">REST API</a>. For
the former, itâ€™s sufficient to be logged in and identify the ID of the application,
while for the latter, we need to <a href="https://docs.microsoft.com/en-us/cli/azure/ext/application-insights/monitor/app-insights/api-key?view=azure-cli-latest#ext-application-insights-az-monitor-app-insights-api-key-create">generate an API key</a>.
Bear in mind that the App Insights ID is different than identification numbers used anywhere else.</p>

<h3 id="time">Time</h3>

<p>First, we need to get Azure CLI running. You might use a <a href="https://gist.github.com/mcopik/20ffbc1a5a70cb3fa4def3677bc06f17">Dockerfile</a>
that provides an image with Azure CLI and Azure Function Tools and log in with
the help of a browser. Alternatively, you can read my previous post on non-interactive login in Azure CLI.
To use application insights in a CLI mode, it is necessary to install an extension - for some reason,
it is not provided by default on Linux platforms:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az monitor: 'app-insights' is not in the 'az monitor' command group.
See 'az monitor --help'. If the command is from an extension, please make sure the
corresponding extension is installed. To learn more about extensions, please visit
https://docs.microsoft.com/en-us/cli/azure/azure-cli-extensions-overview
az extension add --name application-insights
</code></pre></div></div>

<p>First, we need to identify the ID by using App Insights components:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">az monitor app-insights component show
[
  {
    "appId": "XXX-XXX-XXX",
</span><span class="c">    ...
</span><span class="go">    "name": "XXXXX",
</span><span class="c">    ...
</span><span class="go">  }
]
</span></code></pre></div></div>

<p>Afterward, we can run queries on metrics or access all events related to a specific function,
using <a href="https://docs.microsoft.com/en-us/cli/azure/ext/application-insights/monitor/app-insights/events?view=azure-cli-latest">az monitor app-insights events</a>.
For example, receiving all execution requests of a function for the last 12h will
look like this, including much more verbose output with all details on execution:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">az monitor app-insights events show --type requests --app $</span><span class="o">{</span>appID<span class="o">}</span> <span class="nt">--offset</span> 12h
<span class="go">{
  "value": [
    {
</span><span class="c">      ...
</span><span class="go">      "request": {
        "duration": 606.0171,
        "id": "1a47461ed084a14a",
        "name": "handler",
        "performanceBucket": "500ms-1sec",
        "resultCode": "200",
        "source": "",
        "success": "True",
        "url": "https://411-image-recognition-python-3d785dee.azurewebsites.net/api/handler"
      },
</span><span class="c">      ...
</span><span class="go">    },
</span><span class="c">    ...
</span><span class="go">  ]
}
</span></code></pre></div></div>

<p>Flags <code class="language-plaintext highlighter-rouge">--start-time</code> and <code class="language-plaintext highlighter-rouge">--end-time</code> can be used to specify the exact time series
for a data query.
Events corresponding to function app execution contain additional data in
<code class="language-plaintext highlighter-rouge">customDimensions</code> field. This data can be used to find out the function invocation
by using the <code class="language-plaintext highlighter-rouge">InvocationId</code> field.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"customDimensions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"ai_legacyRequestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"FunctionExecutionTimeMs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2279.5392"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"TriggerReason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This function was programmatically called via the host APIs."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"FullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Functions.handler"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Category"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Host.Results"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"InvocationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"HostInstanceId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ProcessId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"37"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"HttpMethod"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"HttpPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/handler"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>However, this data is not available when using Azure CLI.
It can always be accessed through the <a href="https://dev.applicationinsights.io/">REST API</a>, though.
To access it, we need the application ID accessed earlier and an API key created with
<code class="language-plaintext highlighter-rouge">az monitor app-insights api-key create</code> command. However, the API does not allow
to specify a detailed time interval which could be helpful to process a subset
of requests easily.</p>

<p>Finally, we can achieve the goal of finding correct requests by using detailed time
filtering with queries. For example, the following query looks for requests
with a given function app, function name and executed in a given time interval.
Results include a timestamp of the event, function name, boolean value signalizing
whether the execution was successful, result code, duration of the event, function app
name, invocation ID, and function execution time.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>requests
| project timestamp, operation_Name, success, resultCode, duration, cloud_RoleName, invocationId=customDimensions['InvocationId'], functionTime=customDimensions['FunctionExecutionTimeMs']
| where cloud_RoleName =~ 'FUNC_APP_NAME' and operation_Name =~ 'FUNC_NAME'
| where timestamp &gt; todatetime('2020-01-22 17:25:02 +01:00') and timestamp &lt; todatetime('2020-01-22 17:26:02 +01:00')
| order by timestamp desc
</code></pre></div></div>

<p>This query can be executed with Azure CLI as well:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az monitor app-insights query <span class="nt">--app</span> <span class="k">${</span><span class="nv">APP_ID</span><span class="k">}</span> <span class="nt">--analytics-query</span>
<span class="s2">"requests | project timestamp, operation_Name, success, resultCode, duration, cloud_RoleName,
invocationId=customDimensions['InvocationId'],
functionTime=customDimensions['FunctionExecutionTimeMs']"</span>
<span class="nt">--start-time</span> 2020-01-22 17:25:02 +01:00
<span class="nt">--end-time</span> 2020-01-22 17:26:02 +01:00
<span class="o">{</span>
  <span class="s2">"tables"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"columns"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"timestamp"</span>,
          <span class="s2">"type"</span>: <span class="s2">"datetime"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"operation_Name"</span>,
          <span class="s2">"type"</span>: <span class="s2">"string"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"success"</span>,
          <span class="s2">"type"</span>: <span class="s2">"string"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"resultCode"</span>,
          <span class="s2">"type"</span>: <span class="s2">"string"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"duration"</span>,
          <span class="s2">"type"</span>: <span class="s2">"real"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"cloud_RoleName"</span>,
          <span class="s2">"type"</span>: <span class="s2">"string"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"invocationId"</span>,
          <span class="s2">"type"</span>: <span class="s2">"dynamic"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"name"</span>: <span class="s2">"functionTime"</span>,
          <span class="s2">"type"</span>: <span class="s2">"dynamic"</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"name"</span>: <span class="s2">"PrimaryResult"</span>,
      <span class="s2">"rows"</span>: <span class="o">[</span>
        <span class="o">[</span>
          <span class="s2">"2020-01-22T16:25:02.9820857Z"</span>,
          <span class="s2">"handler"</span>,
          <span class="s2">"True"</span>,
          <span class="s2">"200"</span>,
          7691.1008,
          <span class="s2">"111-dynamic-html-python-1489d84c"</span>,
          <span class="s2">"XXXX"</span>,
          <span class="s2">"2279.5392"</span>
        <span class="o">]</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="memory">Memory</h3>

<p>Azure Functions hosts function executions from a single function app inside the same process,
making it quite difficult to measure memory consumption of a single function, as <a href="https://github.com/Azure/azure-functions-host/issues/1451">confirmed by the Azure
Functions team</a>.
Even though memory is an important metric and itâ€™s necessary to understand billing and resource
requirements correctly, this feature does not seem to be a priority for the team.</p>

<p>What can we do? Instead of periodically measuring memory consumption, as it is
possible in some languages, <a href="https://nodejs.org/api/process.html#process_process_memoryusage">like NodeJS</a>,
we can use Azure Metrics to obtain averaged values. Obviously, such data is only
valid and meaningful for function apps consisting of a single function.
Otherwise, the data can represent a value averaged across completely different functions.</p>

<p>If we want to take a look at memory consumption of an entire function app,
<a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-consumption-costs">the recommended solution</a> is to run a query on 
performance counters to find out values of <code class="language-plaintext highlighter-rouge">Private Bytes</code> counter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>performanceCounters
| project timestamp, name, counter, value, cloud_RoleName
| where cloud_RoleName =~ 'FUNCTION_APP'
| project-away cloud_RoleName 
| order by timestamp desc
</code></pre></div></div>

<p>This command can return values such as:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">timestamp [UTC]</th>
      <th style="text-align: center">counter</th>
      <th style="text-align: center">value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1/22/2020, 3:04:30.763 PM</td>
      <td style="text-align: center">Private Bytes</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">1/22/2020, 3:04:30.763 PM</td>
      <td style="text-align: center">% Processor Time Normalized</td>
      <td style="text-align: center">0.425</td>
    </tr>
    <tr>
      <td style="text-align: center">1/22/2020, 3:04:30.762 PM</td>
      <td style="text-align: center">% Processor Time</td>
      <td style="text-align: center">0.85</td>
    </tr>
  </tbody>
</table>

<p>In my case, the memory consumption is not counted correctly for Python function
apps on the Linux system. <a href="https://github.com/Azure/Azure-Functions/issues/1462">Hopefully, the problem will be resolved soon!</a>.</p>


  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
