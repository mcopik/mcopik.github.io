<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | C++ Toolchain with Taint Analysis</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2020/dataflow/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">C++ Toolchain with Taint Analysis</h1>
    <p class="post-meta">February 24, 2020</p>
  </header>

  <article class="post-content">
    <p>Clang comes with a set of tools known as <em>sanitizers</em> that provide a runtime
verification of common problems such as memory issues and undefined behavior.
An interesting and a not well-known one is DfSan, a dataflow sanitizer. The name
does not really reveal the true purpose: the library brings a compiler pass
and runtime to implement <strong>taint analysis</strong><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. The main purpose is to <strong>taint</strong>
specific memory regions and automatically propagate taint labels to other locations
in memory that are affected by originally tainted regions. Taint labels are stored
separately, in a so-called shadow memory, and compiler pass instruments codes
with taint propagation. Thus, it is possible for every variable in a program to detect
which values have affected it. The analysis is not only fully inter-procedural
but it is completely memory agnostic, which is a common issue for static compiler
analyses. The sanitizer implements <strong>data-flow tainting</strong>, the most common way of propagating labels:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Taint label input_parameter detected in y!</span>
  <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
  <span class="n">do_something_important</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">input_parameter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">taint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_parameter</span><span class="p">,</span> <span class="s">"input_parameter"</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">input_parameter</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
</code></pre></div></div>

<p>As a sidenote, we notice that variables can be affected through control-flow
decision as well:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
<span class="n">taint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="s">"m"</span><span class="p">);</span>
<span class="n">taint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="s">"n"</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// sum is m * n</span>
<span class="c1">// sum should have both `m` and `n` as taint labels</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="n">sum</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
</code></pre></div></div>

<p>The feature of control-flow tainting<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> has not been implemented in DfSan yet.</p>

<p>To be fully precise, DfSan needs to instrument all library functions by propagating taint labels across
function arguments and return values. As a result, it creates a wrapper function
for each function found in the program. When handling functions that cannot be
instrumented, e.g. library functions for which only declaration is available,
the function will be considered as potentially problematic unless dfsan is
notified through an ABI blacklist that this function does not write into
user-accessible memory. For such function there can be no taint propagation or
the taint label of return value from the function is overapproximated as a combination
of taint labels in all input variables.</p>

<p>To make sure that we cover everything, we have to instrument all libraries
used by the program, including the standard C++ library.</p>

<h3 id="goal">Goal</h3>

<p>The main goal is to assemble a complete C++ toolchain with a support for
dataflow (taint) analysis. According to Clang documentation<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>,
the complete pipeline includes not only a compiler,
but a linker, language standard library implementation and a runtime library. 
First, we‚Äôre going to <a href="#build-clang-with-sanitizers">build Clang with compiler runtime</a>. Afterwards, we‚Äôre 
going to use the new build of clang to <a href="#c-standard-library">prepare sanitized build of libc++</a>.
Finally, we build libunwind, the library implementing stack unwinding which
is necessary for exception handling, and <a href="#complete-toolchain">assemble the toolchain in a Docker
image </a> to form a single distribution of a C++ dfsan pipeline.
To demonstrate the tool usability for HPC
software, we‚Äôre going to take a look on builds with <a href="#openmp">OpenMP</a> and <a href="#mpi">MPI</a>.</p>

<h3 id="shared-libraries">Shared libraries</h3>

<p>Static libraries are prefered for dfsan to avoid issues with memory mappings.
However, statical link of libraries might lead to serious issues when a specific
library is linked more than once. For example, an application might link
both OpenMP and a library already using OpenMP, leading to a scenario where
two OpenMP runtimes are present. That could have catastrophic effects on the
performance but it‚Äôs not something that we should worry about when trying to instrument an application<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>.</p>

<h3 id="using-dfsan">Using DfSan</h3>

<p>Dfsan might produce a huge number of warnings related on uninstrumented functions.
It‚Äôs quite benefitial to look through the log at least. Although a significant part
of libc is uninstrumented and <code class="language-plaintext highlighter-rouge">sqrt</code> computing square root is marked as functional, implying
that taint label of return value is infered from labels of input arguments,
the cubic root function <code class="language-plaintext highlighter-rouge">cbrt</code> is marked only as <code class="language-plaintext highlighter-rouge">uninstrumented</code>.
Afterwards it‚Äôs better to disable the output log entirely with the environment
variable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DFSAN_OPTIONS=warn_unimplemented=0
</code></pre></div></div>

<h2 id="build-clang-with-sanitizers">Build Clang with sanitizers</h2>

<p>First, we need to get LLVM and clang with the support to sanitizers - we‚Äôre
going to use dataflow sanitizer (dfsan). There are three ways to achieve that:</p>
<ul>
  <li>get prebuilt packages via APT for Debian-based systems: https://apt.llvm.org/</li>
  <li>build from sources, starting with cloning the <a href="https://github.com/llvm/llvm-project">repository</a>
and switching to branch corresponding to selected release</li>
  <li>download sources or prebuilt binaries from <a href="http://releases.llvm.org/download.html">sources</a>.
The important part is we need to build Clang with compiler-rt since the latter
provides sanitizers.</li>
</ul>

<p>The build itself is quite straightforward as long as all projects
are placed together, just like in a clone from directory, or in a common directory
i.e. with directories <code class="language-plaintext highlighter-rouge">clang</code> and <code class="language-plaintext highlighter-rouge">compiler-rt</code> along <code class="language-plaintext highlighter-rouge">LLVM</code>. The CMake configuration
with sanitizers and in release mode is as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake <span class="nt">-DLLVM_TARGETS_TO_BUILD</span><span class="o">=</span><span class="s2">"X86"</span><span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nt">-DLLVM_ENABLE_PROJECTS</span><span class="o">=</span><span class="s2">"clang;compiler-rt"</span><span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>Release<span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span>/path/to/install<span class="se">\</span>
  <span class="o">&amp;&amp;</span> /path/to/llvm
</code></pre></div></div>

<p>We can use dataflow sanitizer to propagate taint labels in a dataflow manner!
We do a sanity check by running a shortened version of the <a href="https://clang.llvm.org/docs/DataFlowSanitizer.html">simple example from docs</a>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sanitizer/dfsan_interface.h&gt;
#include &lt;assert.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">i_label</span> <span class="o">=</span> <span class="n">dfsan_create_label</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dfsan_set_label</span><span class="p">(</span><span class="n">i_label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">j_label</span> <span class="o">=</span> <span class="n">dfsan_create_label</span><span class="p">(</span><span class="s">"j"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dfsan_set_label</span><span class="p">(</span><span class="n">j_label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

  <span class="kt">int</span> <span class="n">test</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">dfsan_read_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">));</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">i_label</span><span class="p">));</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">j_label</span><span class="p">));</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Which can be built with just a single additional compiler flag:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/install/path/bin:<span class="nv">$PATH</span>
<span class="c"># make sure we use the correct version</span>
which clang++
clang++ <span class="nt">-fsanitize</span><span class="o">=</span>dataflow dfsan_test.cpp <span class="nt">-o</span> dfsan_test.exe
./dfsan_test.exe
</code></pre></div></div>

<p>The <strong>Docker image</strong> with the complete build is available as <a href="https://hub.docker.com/repository/docker/mcopik/clang-dfsan/tags"><code class="language-plaintext highlighter-rouge">mcopik/clang-dfsan:clang-${VERSION}</code></a>.</p>

<h2 id="c-standard-library">C++ Standard Library</h2>

<p>We want to build both <a href="https://libcxx.llvm.org/">libcxx</a> and <a href="https://libcxxabi.llvm.org/">libcxxabi</a>
to provide a fully sanitized standard library implementation that can be used
by C++ applications. The libraries are easily built as a part of LLVM tree by
selectin LLVM projects <code class="language-plaintext highlighter-rouge">libcxx</code> and <code class="language-plaintext highlighter-rouge">libcxxabi</code>, similarly to the previous setup.
However, this requires generation of targets for the entire LLVM project and
we can‚Äôt easily reuse previous build step because compiler flags are now different.</p>

<p>Fortunately, the libraries support a standalone build although it is a bit more complicated
due to a cyclic dependency: <code class="language-plaintext highlighter-rouge">libcxx</code> requires <code class="language-plaintext highlighter-rouge">libcxxabi</code> whereas <code class="language-plaintext highlighter-rouge">libcxxabi</code> requires existence of <code class="language-plaintext highlighter-rouge">libcxx</code>
headers. The most generic approach would be to build <code class="language-plaintext highlighter-rouge">libcxx</code> against a different ABI,
such as <code class="language-plaintext highlighter-rouge">libstdc++</code>, build <code class="language-plaintext highlighter-rouge">libcxxabi</code> and then finally rebuild <code class="language-plaintext highlighter-rouge">libcxx</code> with a proper
ABI. But we can take a shortcut here since <code class="language-plaintext highlighter-rouge">libcxxabi</code> requires only headers
from the other library, and for that reason we don‚Äôt need a full build.</p>

<p>First, let‚Äôs create a static build of <code class="language-plaintext highlighter-rouge">libcxxabi</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span><span class="se">\</span>
  <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>MinSizeRel<span class="se">\</span>
  <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span>/path/to/install<span class="se">\</span>
  <span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang<span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++<span class="se">\</span>
  <span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="nt">-fsanitize</span><span class="o">=</span>dataflow<span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="nt">-fsanitize</span><span class="o">=</span>dataflow<span class="se">\</span>
  <span class="nt">-DLLVM_PATH</span><span class="o">=</span>/path/to/llvm/install<span class="se">\</span>
  <span class="nt">-DLIBCXXABI_ENABLE_SHARED</span><span class="o">=</span>NO<span class="se">\</span>
  <span class="nt">-DLIBCXXABI_LIBCXX_PATH</span><span class="o">=</span>../libcxx<span class="se">\</span>
  ../libcxxabi
</code></pre></div></div>

<p>This will create a single static library file <code class="language-plaintext highlighter-rouge">lib/libc++abi.a</code>. Then, we can
get a libc++. In addition, we can use the experimental option <code class="language-plaintext highlighter-rouge">LIBCXX_ENABLE_STATIC_ABI_LIBRARY</code>
to link the contents of <code class="language-plaintext highlighter-rouge">libcxxabi</code> with our static copy of <code class="language-plaintext highlighter-rouge">libcxx</code>. This simplifies
further usage since <code class="language-plaintext highlighter-rouge">libc++abi.a</code> does not have to be specified every time as link-time
dependency.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span><span class="se">\</span>
  <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>MinSizeRel<span class="se">\</span>
  <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span>/opt/llvm<span class="se">\</span>
  <span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang<span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++<span class="se">\</span>
  <span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="nt">-fsanitize</span><span class="o">=</span>dataflow<span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="nt">-fsanitize</span><span class="o">=</span>dataflow<span class="se">\</span>
  <span class="nt">-DLIBCXX_ENABLE_SHARED</span><span class="o">=</span>OFF<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI</span><span class="o">=</span>libcxxabi<span class="se">\</span>
  <span class="nt">-DLIBCXX_ENABLE_STATIC_ABI_LIBRARY</span><span class="o">=</span>ON<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI_INCLUDE_PATHS</span><span class="o">=</span>../libcxxabi/include/<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI_LIBRARY_PATH</span><span class="o">=</span>../build_libcxxabi/lib/<span class="se">\</span>
  ../libcxx
</code></pre></div></div>

<p>Afterwards we should only <code class="language-plaintext highlighter-rouge">libc++.a</code> in the <code class="language-plaintext highlighter-rouge">${INSTALL}/lib</code>
directory. Let‚Äôs do a simple sanity check to verify that our new build works
correctly:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;vector&gt;
#include &lt;numeric&gt;
#include &lt;cassert&gt;
</span>
<span class="cp">#include &lt;sanitizer/dfsan_interface.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">i_label</span> <span class="o">=</span> <span class="n">dfsan_create_label</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dfsan_set_label</span><span class="p">(</span><span class="n">i_label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">j_label</span> <span class="o">=</span> <span class="n">dfsan_create_label</span><span class="p">(</span><span class="s">"j"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dfsan_set_label</span><span class="p">(</span><span class="n">j_label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vec</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">};</span>
  <span class="n">dfsan_label</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">dfsan_read_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vec</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">i_label</span><span class="p">));</span>

  <span class="kt">int</span> <span class="n">test</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">vec</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">j</span><span class="p">);</span>
  <span class="n">test_label</span> <span class="o">=</span> <span class="n">dfsan_read_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">));</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">i_label</span><span class="p">));</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">j_label</span><span class="p">));</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To build this, we need to specify in clang arguments that <code class="language-plaintext highlighter-rouge">libc++</code> should be used.
Furthermore, we need to provide include and library directories to libc++, unless
the standard library was installed in the same directory tree as clang.
In such case, the compiler will be able to pick up paths automatically. The link
with <code class="language-plaintext highlighter-rouge">libc++abi</code> is unnecesary when libraries were merged in the last build step.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang++ <span class="nt">-I</span> /path/to/libc++/installation/include/c++/v1<span class="se">\</span>
  <span class="nt">-fsanitize</span><span class="o">=</span>dataflow<span class="se">\</span>
  <span class="nt">-L</span> /path/to/libc++/installation/lib<span class="se">\</span>
  <span class="nt">-Wl</span>,--start-group,-lc++abi<span class="se">\</span>
  <span class="nt">-stdlib</span><span class="o">=</span>libc++ dfsan_test.cpp<span class="se">\</span>
  <span class="nt">-o</span> dfsan_test.exe
</code></pre></div></div>

<p>The <strong>Docker image</strong> with the complete build is available as <a href="https://hub.docker.com/repository/docker/mcopik/clang-dfsan/tags">`mcopik/clang-dfsan:libcxx-${VERSION}</a>.</p>

<h2 id="complete-toolchain">Complete Toolchain</h2>

<p>Finally, we can assemble a complete C++ toolchain. In addition to standard C++ library,
the compilation workflow has several dependencies such as linker, runtime library
or implementation of exceptions. One could use standard, widely-used and easily available
tools or try to build a pure LLVM pipeline.</p>

<h3 id="gcc">GCC</h3>

<p>The required packages on a Ubuntu-based distro are <strong>binutils</strong> for standard GNU
linker <strong>ld</strong>, <strong>libc-dev</strong> for standard C library and <strong>libgcc-${VERSION}-dev</strong>
to provide runtime library and stack unwinder. Atomics require additional libraries<sup id="fnref:2:1" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>.</p>

<h3 id="clang">Clang</h3>

<p>On Debian-based distributions, I recommend to use <strong>libc-6-dev</strong> since it‚Äôs
perfectly compatible with clang programs. The necessary runtime functions are
already provided with <strong>compiler-rt</strong>. Common alternatives to <strong>GNU ld</strong> linker
are <strong>GNU gold</strong> or <strong>LLVM lld</strong>.</p>

<p>Again, the <strong>Docker image</strong> with the complete build is available as <a href="https://hub.docker.com/repository/docker/mcopik/clang-dfsan/tags"><code class="language-plaintext highlighter-rouge">mcopik/clang-dfsan:dfsan-${VERSION}</code></a>.
It comes with two wrappers, <code class="language-plaintext highlighter-rouge">clang-dfsan</code> and <code class="language-plaintext highlighter-rouge">clang++-dfsan</code>, that include
flags necessary to enable dataflow sanitization and link against dedicated build
of <code class="language-plaintext highlighter-rouge">libc++</code>.</p>

<h2 id="openmp">OpenMP</h2>

<p>LLVM has a separate implementation of <a href="https://openmp.llvm.org/">OpenMP</a>, a widely-used library for multithreading
and shared-memory parallelism. The build steps are similar to other project, with minor
differences. First, an additional CMake parameter <code class="language-plaintext highlighter-rouge">LIBOMP_ENABLE_SHARED=Off</code> is
used to enforce building a static library. Second, there are several functions that cannot be instrumented because their
implementations are provided only in assembly. On Linux, these functions are provided in <code class="language-plaintext highlighter-rouge">runtime/src/z_Linux_asm.S</code>
and dfsan blacklist has to be updated:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun:__kmp_x86_cpuid=uninstrumented
fun:__kmp_x86_cpuid=discard
fun:__kmp_store_x87_fpu_control_word=uninstrumented
fun:__kmp_store_x87_fpu_control_word=discard
fun:__kmp_load_x87_fpu_control_word=uninstrumented
fun:__kmp_load_x87_fpu_control_word=discard
fun:__kmp_clear_x87_fpu_status_word=uninstrumented
fun:__kmp_clear_x87_fpu_status_word=functional
fun:__kmp_hardware_timestamp=uninstrumented
fun:__kmp_hardware_timestamp=discard

fun:__kmp_fork_call=uninstrumented
fun:__kmp_fork_call=functional
fun:__kmp_serialized_parallel=uninstrumented
fun:__kmp_serialized_parallel=functional
fun:__kmp_invoke_microtask=uninstrumented
fun:__kmp_invoke_microtask=functional
</code></pre></div></div>

<p>The library can be build similarly to the previous step:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span><span class="se">\</span>
  <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span>MinSizeRel<span class="se">\</span>
  <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span>/opt/llvm<span class="se">\</span>
  <span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang<span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++<span class="se">\</span>
  <span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="s2">"-fsanitize=dataflow -fsanitize-blacklist=/dfsan_abilist.txt"</span><span class="se">\</span>
  <span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s2">"-fsanitize=dataflow -fsanitize-blacklist=/dfsan_abilist.txt"</span><span class="se">\</span>
  <span class="nt">-DLIBCXX_ENABLE_SHARED</span><span class="o">=</span>OFF<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI</span><span class="o">=</span>libcxxabi<span class="se">\</span>
  <span class="nt">-DLIBCXX_ENABLE_STATIC_ABI_LIBRARY</span><span class="o">=</span>ON<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI_INCLUDE_PATHS</span><span class="o">=</span>../libcxxabi/include/<span class="se">\</span>
  <span class="nt">-DLIBCXX_CXX_ABI_LIBRARY_PATH</span><span class="o">=</span>../build_libcxxabi/lib/<span class="se">\</span>
  ../libcxx
</code></pre></div></div>

<p>Finally, we can try to compile a program parallelized with OpenMP by adding the
flags <code class="language-plaintext highlighter-rouge">-I/path/to/openmp/include -fopenmp /path/to/openmp/lib/libiomp5.a</code>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;vector&gt;
#include &lt;numeric&gt;
#include &lt;cassert&gt;
</span>
<span class="cp">#include &lt;omp.h&gt;
</span>
<span class="cp">#include &lt;sanitizer/dfsan_interface.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">dfsan_label</span> <span class="n">m_label</span> <span class="o">=</span> <span class="n">dfsan_create_label</span><span class="p">(</span><span class="s">"m"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dfsan_set_label</span><span class="p">(</span><span class="n">m_label</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

  <span class="cp">#pragma omp parallel
</span>  <span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">omp_get_num_threads</span><span class="p">()];</span>
    <span class="cp">#pragma omp for
</span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">sum</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">dfsan_label</span> <span class="n">test_label</span> <span class="o">=</span> <span class="n">dfsan_read_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">dfsan_has_label</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">m_label</span><span class="p">));</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="n">sum</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="mpi">MPI</h2>

<p>The MPI can be compiled with dfsan support, an example of build for OpenMPI:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CC</span><span class="o">=</span><span class="k">${</span><span class="nv">CLANG</span><span class="k">}</span> <span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">"-fsanitize=dataflow"</span><span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">OPENMPI_DIR</span><span class="k">}</span>/configure<span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nt">--enable-static</span><span class="o">=</span><span class="nb">yes</span><span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nt">--enable-shared</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<p>Compiling the library requires additional blacklist update because small assembly
functions are used during the configuration to test the compiler:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun:gsym_test_func=uninstrumented
</code></pre></div></div>

<p>Apart from that change, the compilation should work seamlessly.
C++ compiler should be unnecessary because C++ bindings are deprecated and not built by default</p>

<p>An entirely different question is if instrumenting MPI is even necessary?
MPI operations tend to overwrite memory content with data received from network
and it requires an additional library to handle label propagation through MPI
messages. Furthermore, using a dedicated build prevents from running the program
on a supercomputer. Thus, a better option might be to simply put MPI functions in the
blacklist.</p>

<h2 id="references">References</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Taint_checking">Taint checking on Wikipedia</a>¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="http://bitblaze.cs.berkeley.edu/papers/dta++-ndss11.pdf">Kang et al., ‚ÄúDTA++: Dynamic Taint Analysis withTargeted Control-Flow Propagation‚Äù</a>¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a>¬†<a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://clang.llvm.org/docs/Toolchain.html">Clang: Assembling a Complete Toolchain</a>¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="http://lists.llvm.org/pipermail/openmp-dev/2016-January/001051.html">January 2016, [Openmp-dev] Building a static LLVM OpenMP library?</a>¬†<a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
