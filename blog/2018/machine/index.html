<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | LLVM Machine Passes</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2018/machine/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">LLVM Machine Passes</h1>
    <p class="post-meta">October 9, 2018</p>
  </header>

  <article class="post-content">
    <p>LLVM has a very rich set of analysis and transformation passes dedicated to operate on the Intermediate Representation (IR) format which is used as a common abstraction between the frontend operating on the very high level of source code, and the backend responsible for lowering the IR into a respective target ISA. The IR is provided in a static single assignment form (SSA)<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. The primary feature of SSA is the requirement of a single assignment to every variable. Although LLVM as a project suffers from many undocumented features and tools, the documentation on IR passes is suprisingly good, including a propably complete list of available passes<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> and a quite good introduction<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> on implementing passes, although the content on pass manager and specifying requirements could be updated to reflect the difference between legacy and modern pass manager.</p>

<p>But what happens when we try to analyze the machine representation of the code on the target side? According to code generator documentation<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> and the avery good article â€˜Life of an instruction in LLVMâ€™<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>, IR building blocks have their counterparts in the backend. An IR function is represented by a <a href="https://llvm.org/docs/CodeGenerator.html#the-machinefunction-class"><code class="language-plaintext highlighter-rouge">MachineFunction</code></a> on the backend side. <code class="language-plaintext highlighter-rouge">MachineFunction</code> contains possibly multiple <a href="https://llvm.org/docs/CodeGenerator.html#the-machinebasicblock-class"><code class="language-plaintext highlighter-rouge">MachineBasicBlock</code></a> instances, and machine basic blocks contain instances of <a href="https://llvm.org/docs/CodeGenerator.html#the-machineinstr-class"><code class="language-plaintext highlighter-rouge">MachineInstruction</code></a>. These three types have different relationships with their IR counterparts. A <code class="language-plaintext highlighter-rouge">MachineFunction</code> always represents an IR <code class="language-plaintext highlighter-rouge">Function</code> while the <code class="language-plaintext highlighter-rouge">MachineBasicBlock</code> <strong>might</strong> map a BasicBlock but it does not have to! Thatâ€™s why <code class="language-plaintext highlighter-rouge">getFunction()</code> returns a reference and <code class="language-plaintext highlighter-rouge">getBasicBlock()</code> returns a pointer which might be null. Finally, the machine instruction does not correspond directly to IR <code class="language-plaintext highlighter-rouge">Instruction</code> at all.</p>

<p>But why is there a one-to-many mapping in basic blocks? The example below explains how the abstracted view of the machine in the IR canâ€™t match perfectly the actual assembly.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">    
<span class="kt">double</span> <span class="nf">f</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This code is compiled in clang with flags <code class="language-plaintext highlighter-rouge">-O3 -fno-vectorize -fno-unroll-loops</code> to keep the code simple; loop vectorization and unrolling will create additional machine basic blocks as well but the representation is harder to understand.</p>

<div class="language-llvm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    
<span class="c1">; Function Attrs: norecurse nounwind readonly uwtable</span>
<span class="k">define</span> <span class="k">dso_local</span> <span class="kt">double</span> <span class="vg">@_Z1fPdi</span><span class="p">(</span><span class="kt">double</span><span class="p">*</span> <span class="k">nocapture</span> <span class="k">readonly</span><span class="p">,</span> <span class="kt">i32</span><span class="p">)</span> <span class="k">local_unnamed_addr</span> <span class="p">{</span>
  <span class="nv">%3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">sgt</span> <span class="kt">i32</span> <span class="nv">%1</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%3</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%4</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%6</span>

<span class="c1">; &lt;label&gt;:4:                                      ; preds = %2</span>
  <span class="nv">%5</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i32</span> <span class="nv">%1</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%8</span>

<span class="c1">; &lt;label&gt;:6:                                      ; preds = %8, %2</span>
  <span class="nv">%7</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">double</span> <span class="p">[</span> <span class="m">1.000000e+00</span><span class="p">,</span> <span class="nv">%2</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%13</span><span class="p">,</span> <span class="nv">%8</span> <span class="p">]</span>
  <span class="k">ret</span> <span class="kt">double</span> <span class="nv">%7</span>

<span class="c1">; &lt;label&gt;:8:                                      ; preds = %8, %4</span>
  <span class="nv">%9</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%4</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%14</span><span class="p">,</span> <span class="nv">%8</span> <span class="p">]</span>
  <span class="nv">%10</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">double</span> <span class="p">[</span> <span class="m">1.000000e+00</span><span class="p">,</span> <span class="nv">%4</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%13</span><span class="p">,</span> <span class="nv">%8</span> <span class="p">]</span>
  <span class="nv">%11</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">*</span> <span class="nv">%0</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%9</span>
  <span class="nv">%12</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">*</span> <span class="nv">%11</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv">%13</span> <span class="p">=</span> <span class="k">fadd</span> <span class="kt">double</span> <span class="nv">%10</span><span class="p">,</span> <span class="nv">%12</span>
  <span class="nv">%14</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nuw</span> <span class="k">nsw</span> <span class="kt">i64</span> <span class="nv">%9</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%15</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="kt">i64</span> <span class="nv">%14</span><span class="p">,</span> <span class="nv">%5</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%15</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%6</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%8</span>
<span class="p">}</span>


</code></pre></div></div>

<p>This is the most basic representation of our code - if the second parameter <code class="language-plaintext highlighter-rouge">length</code> is greater than zero, the control flow reaches loop preheader with label <code class="language-plaintext highlighter-rouge">4</code> and then loop with label <code class="language-plaintext highlighter-rouge">8</code> where the actual computation is performed. The exit block <code class="language-plaintext highlighter-rouge">6</code> defines the final result returned from the function with a <code class="language-plaintext highlighter-rouge">phi node</code> which selects either a constant 1 or the loop result, depending on whether the loop has executed at least one iteration. PHI nodes are a very fundamental concepts in the SSA representation but they donâ€™t exist in hardware. Therefore, in this case the basic block is duplicated as we can see on the listing below.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    
<span class="err">#</span> <span class="nf">Machine</span> <span class="nv">code</span> <span class="nv">for</span> <span class="nv">function</span> <span class="nv">_Z1fPdi</span><span class="p">:</span> <span class="nv">NoPHIs</span><span class="p">,</span> <span class="nv">TracksLiveness</span><span class="p">,</span> <span class="nv">NoVRegs</span>
<span class="nf">Constant</span> <span class="nv">Pool</span><span class="p">:</span>
  <span class="nl">cp#0:</span> <span class="err">1</span><span class="nf">.000000e</span><span class="o">+</span><span class="mi">00</span><span class="p">,</span> <span class="nb">al</span><span class="nv">ign</span><span class="err">=</span><span class="mi">8</span>
<span class="nf">Function</span> <span class="nv">Live</span> <span class="nv">Ins</span><span class="p">:</span> <span class="kc">$</span><span class="nb">rdi</span><span class="p">,</span> <span class="kc">$</span><span class="nb">esi</span>

<span class="nf">bb.0</span> <span class="p">(</span><span class="o">%</span><span class="nv">ir</span><span class="o">-</span><span class="nb">bl</span><span class="nv">ock.2</span><span class="p">):</span>
  <span class="nl">successors:</span> <span class="err">%</span><span class="nf">bb.3</span><span class="p">(</span><span class="mh">0x50000000</span><span class="p">),</span> <span class="o">%</span><span class="nv">bb.1</span><span class="p">(</span><span class="mh">0x30000000</span><span class="p">)</span><span class="c1">; %bb.3(62.50%), %bb.1(37.50%)</span>
  <span class="nl">liveins:</span> <span class="nf">$esi</span><span class="p">,</span> <span class="kc">$</span><span class="nb">rdi</span>
  <span class="nf">TEST32rr</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">esi</span><span class="p">,</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">esi</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="kc">$</span><span class="nv">eflags</span>
  <span class="nf">JLE_1</span> <span class="o">%</span><span class="nv">bb.1</span><span class="p">,</span> <span class="nv">implicit</span> <span class="kc">$</span><span class="nv">eflags</span>

<span class="nf">bb.3</span> <span class="p">(</span><span class="o">%</span><span class="nv">ir</span><span class="o">-</span><span class="nb">bl</span><span class="nv">ock.4</span><span class="p">):</span>
<span class="c1">; predecessors: %bb.0</span>
  <span class="nl">successors:</span> <span class="err">%</span><span class="nf">bb.4</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">)</span><span class="c1">; %bb.4(100.00%)</span>
  <span class="nl">liveins:</span> <span class="nf">$esi</span><span class="p">,</span> <span class="kc">$</span><span class="nb">rdi</span>
  <span class="nf">renamable</span> <span class="kc">$</span><span class="nb">eax</span> <span class="err">=</span> <span class="nv">MOV32rr</span> <span class="nv">killed</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">esi</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="kc">$</span><span class="nb">rax</span>
  <span class="nf">renamable</span> <span class="kc">$</span><span class="nv">xmm0</span> <span class="err">=</span> <span class="nv">MOVSDrm</span> <span class="kc">$</span><span class="nv">rip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">$</span><span class="nv">noreg</span><span class="p">,</span> <span class="o">%</span><span class="nv">const.0</span><span class="p">,</span> <span class="kc">$</span><span class="nv">noreg</span> <span class="p">::</span> <span class="p">(</span><span class="nv">load</span> <span class="mi">8</span> <span class="nv">from</span> <span class="nv">constant</span><span class="o">-</span><span class="nv">pool</span><span class="p">)</span>
  <span class="nf">renamable</span> <span class="kc">$</span><span class="nb">ecx</span> <span class="err">=</span> <span class="nv">XOR32rr</span> <span class="nv">undef</span> <span class="kc">$</span><span class="nb">ecx</span><span class="p">(</span><span class="nv">tied</span><span class="o">-</span><span class="nv">def</span> <span class="mi">0</span><span class="p">),</span> <span class="nv">undef</span> <span class="kc">$</span><span class="nb">ecx</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="nv">dead</span> <span class="kc">$</span><span class="nv">eflags</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="kc">$</span><span class="nb">rcx</span>

<span class="nf">bb.4</span> <span class="p">(</span><span class="o">%</span><span class="nv">ir</span><span class="o">-</span><span class="nb">bl</span><span class="nv">ock.8</span><span class="p">,</span> <span class="nb">al</span><span class="nv">ign</span> <span class="mi">4</span><span class="p">):</span>
<span class="c1">; predecessors: %bb.3, %bb.4</span>
  <span class="nl">successors:</span> <span class="err">%</span><span class="nf">bb.2</span><span class="p">(</span><span class="mh">0x04000000</span><span class="p">),</span> <span class="o">%</span><span class="nv">bb.4</span><span class="p">(</span><span class="mh">0x7c000000</span><span class="p">)</span><span class="c1">; %bb.2(3.12%), %bb.4(96.88%)</span>
  <span class="nl">liveins:</span> <span class="nf">$rax</span><span class="p">,</span> <span class="kc">$</span><span class="nb">rcx</span><span class="p">,</span> <span class="kc">$</span><span class="nb">rdi</span><span class="p">,</span> <span class="kc">$</span><span class="nv">xmm0</span>
  <span class="nf">renamable</span> <span class="kc">$</span><span class="nv">xmm0</span> <span class="err">=</span> <span class="nv">ADDSDrm</span> <span class="nv">killed</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nv">xmm0</span><span class="p">(</span><span class="nv">tied</span><span class="o">-</span><span class="nv">def</span> <span class="mi">0</span><span class="p">),</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">rdi</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">rcx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">$</span><span class="nv">noreg</span> <span class="p">::</span> <span class="p">(</span><span class="nv">load</span> <span class="mi">8</span> <span class="nv">from</span> <span class="o">%</span><span class="nv">ir.scevgep</span><span class="p">,</span> <span class="err">!</span><span class="nv">tbaa</span> <span class="err">!</span><span class="mi">2</span><span class="p">)</span>
  <span class="nf">renamable</span> <span class="kc">$</span><span class="nb">rcx</span> <span class="err">=</span> <span class="nv">nuw</span> <span class="nv">nsw</span> <span class="nv">ADD64ri8</span> <span class="nv">killed</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">rcx</span><span class="p">(</span><span class="nv">tied</span><span class="o">-</span><span class="nv">def</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="nv">dead</span> <span class="kc">$</span><span class="nv">eflags</span>
  <span class="nf">CMP64rr</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">rax</span><span class="p">,</span> <span class="nv">renamable</span> <span class="kc">$</span><span class="nb">rcx</span><span class="p">,</span> <span class="nv">implicit</span><span class="o">-</span><span class="nv">def</span> <span class="kc">$</span><span class="nv">eflags</span>
  <span class="nf">JNE_1</span> <span class="o">%</span><span class="nv">bb.4</span><span class="p">,</span> <span class="nv">implicit</span> <span class="kc">$</span><span class="nv">eflags</span>

<span class="nf">bb.2</span> <span class="p">(</span><span class="o">%</span><span class="nv">ir</span><span class="o">-</span><span class="nb">bl</span><span class="nv">ock.6</span><span class="p">):</span>
<span class="c1">; predecessors: %bb.4</span>
  <span class="nl">liveins:</span> <span class="nf">$xmm0</span>
  <span class="nf">RETQ</span> <span class="kc">$</span><span class="nv">xmm0</span>

<span class="nl">bb.1:</span>
<span class="c1">; predecessors: %bb.0</span>

  <span class="nf">renamable</span> <span class="kc">$</span><span class="nv">xmm0</span> <span class="err">=</span> <span class="nv">MOVSDrm</span> <span class="kc">$</span><span class="nv">rip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">$</span><span class="nv">noreg</span><span class="p">,</span> <span class="o">%</span><span class="nv">const.0</span><span class="p">,</span> <span class="kc">$</span><span class="nv">noreg</span> <span class="p">::</span> <span class="p">(</span><span class="nv">load</span> <span class="mi">8</span> <span class="nv">from</span> <span class="nv">constant</span><span class="o">-</span><span class="nv">pool</span><span class="p">)</span>
  <span class="nf">RETQ</span> <span class="kc">$</span><span class="nv">xmm0</span>

<span class="err">#</span> <span class="nf">End</span> <span class="nv">machine</span> <span class="nv">code</span> <span class="nv">for</span> <span class="nv">function</span> <span class="nv">_Z1fPdi.</span>

</code></pre></div></div>

<p>The exit block from IR corresponds to the machine basic block <code class="language-plaintext highlighter-rouge">bb.2</code> which returns the value in vector register <code class="language-plaintext highlighter-rouge">xmm0</code>. Additionally, a second exit block <code class="language-plaintext highlighter-rouge">bb.1</code> is provided for the case when loop is not executed at all. A similar pattern can be seen in the assembly for x86 target where the new block moves the constant value to the register before executing <code class="language-plaintext highlighter-rouge">retq</code>.</p>

<p>From an LLVM bitcode, we can go directly generate object file which in our case is stored as an x86-64 ELF format, by using the LLVM static compiler <a href="https://llvm.org/docs/CommandGuide/llc.html"><code class="language-plaintext highlighter-rouge">llc</code></a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>llc -filetype=obj file.bc -o file.o
</code></pre></div></div>

<p>with the option <code class="language-plaintext highlighter-rouge">-filetype=obj</code>. One can also generate an assembly listing</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>llc -S file.bc -o file.s
llvm-mc -filetype=obj file.bc -o file.o
</code></pre></div></div>

<p>Additionaly, the flag <code class="language-plaintext highlighter-rouge">-asm-show-inst</code> generates the listing with mapping to LLVM machine instructions and operands in comments. When building C/C++ programs, these steps are wrapped inside <code class="language-plaintext highlighter-rouge">clang</code> tool and hidden from the user <sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">6</a></sup>.</p>

<p>The well-documented and properly explained infrastracture ends as soon as we try to write and run passes on machine code representation. It sounds from this <a href="http://lists.llvm.org/pipermail/llvm-dev/2015-November/092058.html">November 2015</a> discussion on the mailing list that thereâ€™s no way of running the pass dynamically during target code generation. llc docs explain that the <code class="language-plaintext highlighter-rouge">-load</code> option, known also in opt, is used to dynamically load targets, not passes. For the purpose of this tutorial, we want to write a pass printing machine blocks and basic statistics on size and correspondence to IR block. <code class="language-plaintext highlighter-rouge">llc</code> already offers an ability to print out machine instructions after every optimization step by using the flag <code class="language-plaintext highlighter-rouge">-print-machineinstrs</code>. The contents of this tutorial are mostly based on the information found on LLVM mailing list<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">7</a></sup>.</p>

<p>The code generation operates in several phases which are responsible for selecting instructions, allocating registers. performing late optimizations such as <a href="https://en.wikipedia.org/wiki/Peephole_optimization">peephole optimizations</a> and emitting the code<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">8</a></sup>. We want to run our pass quite late, just after target optimizations and before the lowering of machine instructions to target code. Since thereâ€™s no way to dynamically load the pass, we need to statically embed our pass in X86 target generation chain.</p>

<p>First, we implement our machine pass that visits functions in the code. As the naming scheme suggests, a machine counterpart of a FunctionPass is simply a <a href="http://llvm.org/doxygen/classllvm_1_1MachineFunctionPass.html">MachineFunctionPass</a>. Only a single function <code class="language-plaintext highlighter-rouge">runOnFunction</code> needs to be implemented . Since we want to print a basic information on block size, it might look like this:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">    
<span class="k">struct</span> <span class="nc">MachinePrinter</span><span class="o">:</span> <span class="k">public</span> <span class="n">llvm</span><span class="o">::</span><span class="n">MachineFunctionPass</span> <span class="p">{</span>

  <span class="k">static</span> <span class="kt">char</span> <span class="n">ID</span><span class="p">;</span>

  <span class="n">MachinePrinter</span><span class="p">()</span><span class="o">:</span>
    <span class="n">MachineFunctionPass</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">F</span><span class="p">)</span>
      <span class="k">override</span>
  <span class="p">{</span> 
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="n">MBB</span> <span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">llvm</span><span class="o">::</span><span class="n">BasicBlock</span> <span class="o">*</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">getBasicBlock</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
        <span class="n">llvm</span><span class="o">::</span><span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">' '</span>
            <span class="o">&lt;&lt;</span> <span class="n">MBB</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">llvm</span><span class="o">::</span><span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">MBB</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">' '</span>
            <span class="o">&lt;&lt;</span> <span class="n">MBB</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="n">inst</span> <span class="o">:</span> <span class="n">BB</span><span class="p">)</span>
        <span class="n">llvm</span><span class="o">::</span><span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">inst</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="n">MachinePrinter</span><span class="o">::</span><span class="n">ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="n">initializeMachinePrinterPass</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">PassRegistry</span> <span class="o">&amp;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">using</span> <span class="n">llvm</span><span class="o">::</span><span class="n">PassRegistry</span><span class="p">;</span>
<span class="k">using</span> <span class="n">llvm</span><span class="o">::</span><span class="n">PassInfo</span><span class="p">;</span>
<span class="k">using</span> <span class="n">llvm</span><span class="o">::</span><span class="n">callDefaultCtor</span><span class="p">;</span>
<span class="n">INITIALIZE_PASS</span><span class="p">(</span><span class="n">MachinePrinter</span><span class="p">,</span> <span class="s">"x86-printer"</span><span class="p">,</span> <span class="s">"X86 Printer"</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
    <span class="n">FunctionPass</span> <span class="o">*</span> <span class="n">createMachinePrinter</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MachinePrinter</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We use the macro <a href="http://llvm.org/doxygen/PassSupport_8h.html"><code class="language-plaintext highlighter-rouge">INITIALIZE_PASS</code></a> as a first step of pass registration. It defines a function <code class="language-plaintext highlighter-rouge">initializePASSNAMEPass</code> in namespace <code class="language-plaintext highlighter-rouge">llvm</code> and we need to provide an additional declaration. Furthermore, we need to supply a function returning a dynamically allocated pass object. Both function are used by the target configuration to add our pass to the pipeline.</p>

<p>The we need a forward declaration of the create function in <a href="https://github.com/llvm-mirror/llvm/blob/d2b1fb11d3f3e5d88bc57c8e0154d367e0e48164/lib/Target/X86/X86.h#L130">lib/Target/X86/X86.h</a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">FunctionPass</span> <span class="o">*</span><span class="n">createMachinePrinter</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Forward decalarations allow compiling the target configuration independently from passes implementation. Thus, passes can be developed and improved without a significant project rebuild. Now we need to insert our analysis pass into X86 target configuration. We start in <a href="https://github.com/llvm-mirror/llvm/blob/master/lib/Target/X86/X86TargetMachine.cpp"><code class="language-plaintext highlighter-rouge">lib/Target/X86/X86TargetMachine.cpp</code></a> with a forward declaration and a call to initialization function in <a href="https://github.com/llvm-mirror/llvm/blob/master/lib/Target/X86/X86TargetMachine.cpp#L59"><code class="language-plaintext highlighter-rouge">lib/Target/X86/X86TargetMachine.cpp</code></a>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">initializeMachinePrinterPass</span><span class="p">(</span><span class="n">PassRegistry</span> <span class="o">&amp;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="nf">LLVMInitializeX86Target</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">PassRegistry</span> <span class="o">&amp;</span><span class="n">PR</span> <span class="o">=</span> <span class="o">*</span><span class="n">PassRegistry</span><span class="o">::</span><span class="n">getPassRegistry</span><span class="p">();</span>
  <span class="p">...</span>
  <span class="n">initializeMachinePrinterPass</span><span class="p">(</span><span class="n">PR</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since I want to look at machine code after all implementations have been finished, the pass is called just at the very end:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">X86PassConfig</span><span class="o">::</span><span class="n">addPreEmitPass2</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createMachinePrinter</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As the last step we modify the <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> in <a href="https://github.com/llvm-mirror/llvm/blob/d2b1fb11d3f3e5d88bc57c8e0154d367e0e48164/lib/Target/X86/CMakeLists.txt"><code class="language-plaintext highlighter-rouge">lib/Target/X86/CMakeLists.txt</code></a> to add the new .cpp file to <code class="language-plaintext highlighter-rouge">sources</code> list. The new pass should be available when using llc to build x86 targets.</p>

<p>As we see, this process is not complicated and one can set up a machine pass prototype in just a few minutes. Itâ€™s a pity that this process is not so well documented and supported as IR passes. And as far as machine basic block statistics are concerned, this method is reliable only when static information is concerned. Dynamic block counts need profiling information that is available on the IR level, and the one-to-many mapping between IR and machine basic block prevent us from obtaining a complete and accurate result. For that purpose one needs to use other instrumentation tool, for example the <code class="language-plaintext highlighter-rouge">Pin</code> tool which is capable of counting <a href="https://software.intel.com/sites/landingpage/pintool/docs/81205/Pin/html/index.html#inscount1">basic block instances</a>.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA on Wikipedia</a>, a <a href="http://ssabook.gforge.inria.fr/latest/book.pdf">free textbook on SSA</a> provided by Inria - work in progress!Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://llvm.org/docs/Passes.html">LLVM Passes</a>Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="http://llvm.org/docs/WritingAnLLVMPass.html">Writing an LLVM Pass</a>Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="http://llvm.org/docs/CodeGenerator.html">The LLVM Target-Independent Code Generator</a>Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><a href="https://eli.thegreenplace.net/2012/11/24/life-of-an-instruction-in-llvm">Life of an instruction LLVM</a>, Eli BenderskyÂ <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p><a href="http://lists.llvm.org/pipermail/llvm-dev/2018-January/120165.html">January 2018</a> mailing list discussion explains the differences between building an application with various pipelines based on clang, opt and llc.Â <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p><a href="http://lists.llvm.org/pipermail/llvm-dev/2015-November/092030.html">November 2015</a> discussion on writing a machine pass, <a href="http://lists.llvm.org/pipermail/llvm-dev/2014-May/072987.html">April 2014</a> discussion which brings the problem of finding correspondence between IR and machine instructions. The mentioned <code class="language-plaintext highlighter-rouge">-debug-ir</code> was deprecated and <a href="https://reviews.llvm.org/rL222945">removed in November 2014</a>. As of October 2018, thereâ€™s an <a href="https://reviews.llvm.org/D40778">open review for a  new debug pass</a>. <a href="https://groups.google.com/forum/#!searchin/llvm-dev/debug-ir%7Csort:date/llvm-dev/PP8C_96rhuI/3ddvu9MVCQAJ">July 2016</a> question on matching machine instructions with IR, no answers unfortunately.Â <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p><a href="http://llvm.org/docs/CodeGenerator.html#high-level-design-of-the-code-generator">High-level design of code generator</a>Â <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
