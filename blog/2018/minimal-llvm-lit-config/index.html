<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Minimal LLVM lit configuration</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2018/minimal-llvm-lit-config/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Minimal LLVM lit configuration</h1>
    <p class="post-meta">October 16, 2018</p>
  </header>

  <article class="post-content">
    <p>LLVM has an integrated testing support which includes tools such as test runner <a href="https://llvm.org/docs/CommandGuide/lit.html">lit</a> or automatic verifier of output <a href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a>. Itâ€™s the easiest way to ensure correctness of an analysis or transformation pass where each unit and regression is implemented in the LLVM IR format and annotated with the expected output. Although documentation describes quite extensively parameters of command line tools, they lack general examples and it is definitely not easy to figure out a starting configuration for lit. <a href="https://github.com/llvm-mirror/llvm/tree/4604874612fa292ab4c49f96aedefdf8be1ff27e/utils/lit/examples/many-tests">The only example</a> in the repository is quite non-standard and specific. It seems that the best way to start is simply to look at existing LLVM projects and copy their solutions. The very same approach was already advised to people asking about lit configuration on <a href="http://lists.llvm.org/pipermail/llvm-dev/2016-January/094037.html">the mailing list</a>. Since larger projects usually have complex configurations supporting multiple features, it takes several tries to obtain a minimum setup for an automatic test.</p>

<p>In this post, Iâ€™m going to describe a minimal lit configuration which assumes distinct source and build directories. This is very suitable for build systems and it can be immediately integrated with CMake.</p>

<p>We start with the main <code class="language-plaintext highlighter-rouge">lit.cfg</code> script, assuming the simpler case where both tests and config file are located somewhere in the main project directory. The first few lines of script are rather self-explanatory. We define the config name, the set of suffixes of test files, <code class="language-plaintext highlighter-rouge">test_format</code> field specifies how tests should be executed and ShTest is a format where one file is used per test case. Later we define the most important field: <code class="language-plaintext highlighter-rouge">test_source_root</code> that is used to locate test files. This works very well if the config file is in the same directory. Otherwise, one would need to define source root differently and use the <code class="language-plaintext highlighter-rouge">test_exec_root</code> to specify where tests should be executed. The <code class="language-plaintext highlighter-rouge">lib_dir</code> variable is a non-necessary helper variable containing the location of built shared library with LLVM pass.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">lit.util</span>
<span class="kn">import</span> <span class="nn">lit.formats</span>

<span class="n">config</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'my-pass'</span>
<span class="n">config</span><span class="p">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s">'.ll'</span><span class="p">]</span>
<span class="n">config</span><span class="p">.</span><span class="n">test_format</span> <span class="o">=</span> <span class="n">lit</span><span class="p">.</span><span class="n">formats</span><span class="p">.</span><span class="n">ShTest</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="n">test_source_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="n">lib_dir</span> <span class="o">=</span> <span class="n">build_dir</span>

<span class="n">config</span><span class="p">.</span><span class="n">substitutions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s">'%loadpass'</span><span class="p">,</span> <span class="s">'-load '</span>
    <span class="o">+</span> <span class="n">config</span><span class="p">.</span><span class="n">lib_dir</span>
        <span class="o">+</span> <span class="s">'/libname.so'</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div></div>

<p>To apply passes on an IR file and test the output of an analysis or transformation, each file needs to start with a definition of how it should be executed. Here the <code class="language-plaintext highlighter-rouge">%loadpass</code> substitution is used to load the developed pass and <code class="language-plaintext highlighter-rouge">%s</code> is a standard substitution for the test file name. Other standard substitution are described in <a href="https://llvm.org/docs/TestingGuide.html#substitutions">docs</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; RUN: opt %loadpass -my-pass \
; RUN: -my-pass-option \
; RUN: &lt; %s | FileCheck %s

</code></pre></div></div>

<p>Each test file contains instructions on how to verify the correctness of the output. Thatâ€™s why the last part of <code class="language-plaintext highlighter-rouge">RUN</code> instruction redirects the output to the <code class="language-plaintext highlighter-rouge">FileCheck</code> program. In the example below, we test a simple pass which prints basic block information. We check that output contains the size of the block and the very next line in the output contains the number of successors.</p>

<div class="language-llvm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">; CHECK-LABEL: size: 2</span>
<span class="c1">; CHECK-NEXT: successors: 0</span>

<span class="nl">merge:</span>
    <span class="nv">%final</span> <span class="p">=</span> <span class="k">add</span> <span class="kt">i8</span> <span class="nv">%c5</span><span class="p">,</span> <span class="nv">%c2</span>
    <span class="k">ret</span> <span class="kt">void</span>
</code></pre></div></div>

<p>This works very well for in-source builds. For an out-of-source build the only missing piece is a build directory defined in the <code class="language-plaintext highlighter-rouge">config.lib_dir</code> variable. This can be easily generalized with CMake to always point to the tests subdirectory for a given build. For that purpose, the original config file is treated as an input template for CMake configuration. Pre-defined symbols are replaced and a new instance of the template is placed in the build directory.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Path to test suite directory
</span><span class="n">config</span><span class="p">.</span><span class="n">test_source_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'@CMAKE_CURRENT_SOURCE_DIR@'</span><span class="p">,</span> <span class="s">'tests'</span><span class="p">)</span>
<span class="c1"># Path to test suite in build directory where tests are executed
</span><span class="n">config</span><span class="p">.</span><span class="n">test_exec_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'@CMAKE_CURRENT_BINARY_DIR@'</span><span class="p">,</span> <span class="s">'tests'</span><span class="p">)</span>
<span class="c1"># Help variable used to locate compiled library
</span><span class="n">config</span><span class="p">.</span><span class="n">lib_dir</span> <span class="o">=</span> <span class="s">'@CMAKE_CURRENT_BINARY_DIR@'</span>
</code></pre></div></div>

<p>The last modification is to add the following line to the <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configure_file(tests/lit.cfg.in tests/lit.cfg @ONLY)
</code></pre></div></div>

<p>This configuration allows for a quick set-up of testing in LLVM-based projects on Linux. Obviously, supporting other platforms would require slight modifications. For example, the shared library file extension <code class="language-plaintext highlighter-rouge">.so</code> is hardcoded in the file.</p>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
