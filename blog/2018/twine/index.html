<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Marcin Copik | Read the Freaking Documentation</title>
<meta name="description" content="Personal webpage">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.css" integrity="sha512-WgL+hxwL4NdLGGZ4Euo/BmGAcQgyRRJsTQbNPGui+nWlzaF+3f2zf2rh578ccU3YINJCi8LvHyV1OHLJ8effBA==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2018/twine/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       Marcin Copik
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/talks/">
                talks
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/students/">
                students
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/misc/">
                miscellaneous
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/cv.pdf" target="_blank" rel="nofollow">
              CV
            </a>
          </li>
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Read the Freaking Documentation</h1>
    <p class="post-meta">September 21, 2018</p>
  </header>

  <article class="post-content">
    <p>During my work on instrumentation in LLVM, I tried several simple loop IR examples to verify that computed basic block frequency is correct. A quite useful tool which helps with understanding IR files is <a href="https://github.com/llvm-mirror/llvm/blob/master/lib/Analysis/CFGPrinter.cpp">CFGPrinter</a> which creates a .dot file with a graphical description of the control flow graph. It can be invoked with flag <code class="language-plaintext highlighter-rouge">-dot-cfg</code> or <code class="language-plaintext highlighter-rouge">-view-cfg</code> to directly open resulting graph in a visualizer.</p>

<p>Soon I discovered that the pass cannot handle correctly IR files with profiling information. I started with the simplest example one can imagine when trying to verify correctness of basic block frequency:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function is used with a standard <code class="language-plaintext highlighter-rouge">main</code> function which calls <code class="language-plaintext highlighter-rouge">f</code> with an array of length 200. I compiled both translation units separately to prevent inlining and I used <code class="language-plaintext highlighter-rouge">-fno-vectorize -fno-unroll-loops</code> to prevent loop optimizations which change the control-flow graph of a loop and make it much harder to understand block frequencies. The listing presents IR with embedded profiling information. There are four basic blocks in this function, the entry block, loop preheader <code class="language-plaintext highlighter-rouge">%4</code>, loop body <code class="language-plaintext highlighter-rouge">%7</code> and exit block <code class="language-plaintext highlighter-rouge">%6</code>.</p>

<script src="https://gist.github.com/mcopik/2c30017a6bc3fb46e690fd5a216ea686.js"></script>

<p>Even though this is a perfectly fine IR with correctly embedded metadata, the CFGPrinter pass would generate an incorrect dot file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>digraph "CFG for '_Z1fPdi' function" {

    label="CFG for '_Z1fPdi' function";

    Node0x5612742de010 [shape=record,label="{%2:\l  %3 = icmp sgt i32 %1, 0\l  br i1 %3, label %4, label %6, !prof !30\l|{&lt;s0&gt;T|&lt;s1&gt;F}}"];
    Node0x5612742de010:s0 -&gt; Node0x5612742de780["];
    Node0x5612742de010:s1 -&gt; Node0x5612742de7d0["];
    Node0x5612742de780 [shape=record,label="{%4:\l\l  %5 = zext i32 %1 to i64\l  br label %7\l}"];
    Node0x5612742de780 -&gt; Node0x5612742df820;
    Node0x5612742de7d0 [shape=record,label="{%6:\l\l  ret void\l}"];
    Node0x5612742df820 [shape=record,label="{%7:\l\l  %8 = phi i64 [ 0, %4 ], [ %12, %7 ]\l  %9 = getelementptr inbounds double, double* %0, i64 %8\l  %10 = load double, double* %9, align 8, !tbaa !31\l  %11 = fadd double %10, 1.100000e+00\l  store double %11, double* %9, align 8, !tbaa !31\l  %12 = add nuw nsw i64 %8, 1\l  %13 = icmp eq i64 %12, %5\l  br i1 %13, label %6, label %7, !prof !35\l|{&lt;s0&gt;T|&lt;s1&gt;F}}"];
    Node0x5612742df820:s0 -&gt; Node0x5612742de7d0["];
    Node0x5612742df820:s1 -&gt; Node0x5612742df820["];
}
</code></pre></div></div>

<p>The issue is not hard to recognize: edge labels are not generated correctly and every not closed quotation mark should be instead a proper edge label. It does not seem to be a misprint of an empty label because PGO provides information on branch weights. What should we expect here is something more like <code class="language-plaintext highlighter-rouge">label="W:100"</code> where 100 might be any value taken by a weight. So far the problem seems to be simple, perhaps a specific print function is taking path which is not properly tested. We can fix that.</p>

<p>A quick inspection of functions used by the pass located the problem in <code class="language-plaintext highlighter-rouge">getEdgeAttributes</code> function in the header <a href="https://github.com/llvm-mirror/llvm/blob/433eb70569ee6379cdd5181e72b9193fdb0a39dd/include/llvm/Analysis/CFGPrinter.h#151">llvm/Analysis/CFGPrinter.h</a>. It checks for several conditions such as non-existing weight, when in fact an empty string is returned. But it‚Äôs not happening in our case since the control flow reaches the very last return statement which is surprisingly simple.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">getEdgeAttributes</span><span class="p">(</span><span class="k">const</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">Node</span><span class="p">,</span> <span class="n">succ_const_iterator</span> <span class="n">I</span><span class="p">,</span> <span class="k">const</span> <span class="n">Function</span> <span class="o">*</span><span class="n">F</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">Twine</span> <span class="n">Attrs</span> <span class="o">=</span> <span class="s">"label=</span><span class="se">\"</span><span class="s">W:"</span> <span class="o">+</span> <span class="n">Twine</span><span class="p">(</span><span class="n">Weight</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">())</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Attrs</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Twine appears to be some kind of a string converter but there is no clear indication of what went wrong in my case. I immediately suspected either a failed implementation of copy constructor or addition operator or a simple bug in the <code class="language-plaintext highlighter-rouge">str</code> method. As a first step, I tried using LLVM streams such as <code class="language-plaintext highlighter-rouge">llvm::outs()</code>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">llvm</span><span class="o">::</span><span class="n">outs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="s">"label=</span><span class="se">\"</span><span class="s">W:"</span> <span class="o">+</span> <span class="n">Twine</span><span class="p">(</span><span class="n">Weight</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">())</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">).</span><span class="n">str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
</code></pre></div></div>

<p>Surprisingly, this worked! The output is now correct and the next step is obvious - find out where is the difference in behavior between <a href="https://github.com/llvm-mirror/llvm/blob/993ef0ca960f8ffd107c33bfbf1fd603bcf5c66c/lib/Support/Twine.cpp#L18"><code class="language-plaintext highlighter-rouge">str</code></a> and <a href="https://github.com/llvm-mirror/llvm/blob/993ef0ca960f8ffd107c33bfbf1fd603bcf5c66c/lib/Support/Twine.cpp#L164"><code class="language-plaintext highlighter-rouge">print</code></a> functionality. In this case, <code class="language-plaintext highlighter-rouge">str</code> creates a <code class="language-plaintext highlighter-rouge">SmallString</code> vector, writes the resulting string to it with <code class="language-plaintext highlighter-rouge">toVector</code> function which internally uses <code class="language-plaintext highlighter-rouge">raw_svector_stream</code>. Since it‚Äôs yet another implementation of LLVM <code class="language-plaintext highlighter-rouge">raw_ostream</code> interface, the result is processed with the very same <code class="language-plaintext highlighter-rouge">print</code> function. Dead end, there‚Äôs no important distinction here.</p>

<p>It seems that we won‚Äôt fix this bug without investigating Twine. <a href="http://llvm.org/docs/ProgrammersManual.html#the-twine-class">Twine is used in LLVM</a> primarily for cheap and lazy string concatenation without using dynamic memory allocation. Internally we have a complex, tree-like data structure with nodes storing various types. The easiest implementation of such pattern consists of polymorphic types to abstract away the actual content of a node. Yet as usual, the easiest solution is not the one providing the best performance. To avoid the cost dynamic calls, dynamic memory allocation and vtables in every object, Twine uses a union to store values and an enum to remember the type of stored value. But how it relates to our problem? The documentation already gives us a hint - Twine objects should not be stored since they use temporary objects as its input. Indeed, a union-based storage captures input data as pointers. And here I have to admit that I spent a considerable amount of time on reading and debugging the code before I even though of looking at LLVM docs. Additionally, I tried to reproduce the issue in a simple application and failed which made the bug much more mysterious and fooled me to believe that there is a much serious issue with memory management. My mistake, I guess. If I started with documentation, I would save a lof time.</p>

<p>With this information, the bug is obvious since Twine creation and string conversion are split into two statements. The problem is caused by storing a complex Twine structure which references temporary objects, in this case, it‚Äôs mostly another Twine instance which is going to be destroyed as soon as the initialization is finished. I verified this by inspecting the internal tree and found out that memory contents are corrupted. The conversion utility works flawlessly but it never receives a correct Twine object. And I don‚Äôt have a perfect explanation of why this problem could not reproduced in a toy application. Perhaps the order of variables on the stack was different and I was successful in accessing correct Twine structure before the memory was overwritten by another variable.</p>

<p>Finally we obtain a readable and clear depiction of control-flow in our function.</p>

<p><img src="/assets/img/blogposts/2018_09_cfg_twine.png" alt="Picture of a fixed CFG." /></p>

<p>Of course, I can not be the first one to find this problem. A bug report was filed in April 2018 on LLVM bug tracker with exactly the same problem - <a href="https://bugs.llvm.org/show_bug.cgi?id=37019">Undefined behavior in CFGPrinter due to Twine misuse</a>. A patch was provided in a separate repository and maybe that‚Äôs why no one bothered to fix it in the last six months. I decided to create a very simple patch and proposed it on Phabricator - <a href="https://reviews.llvm.org/D52933">review D52933</a>. Hopefully, it will go through!</p>

<p>There are three lessons here. Even a proper documentation of specific features and requirements might not prevent experienced developers of misusing a library. Maybe we need a <code class="language-plaintext highlighter-rouge">[potentially_unsafe]</code> <a href="https://en.cppreference.com/w/cpp/language/attributes">attribute specifier</a> for functions and types to make developers more aware? The point here is not to discourage people from using it but merely remind to read the documentation before. Many good APIs allow writing code immediately, simply by inspecting function names and their respective parameters. However, not every library is meant to be used that way.</p>

<p>After finding the bug, I talked with a local LLVM guru and asked him about Twine. His response was basically: ‚Äúyeah, Twine is a constant problem generator, just use <code class="language-plaintext highlighter-rouge">std::to_string</code>‚Äù. Here comes the second lesson which is more personal - if you look for a bug and discover it somewhere in an in-house, custom piece of software, think twice if you really want to spend time looking for a source of the problem. However, if it smells just a little bit of dangling pointers - send a bug report and run like hell.</p>

<p>And the last lesson? Read the Freaking Documentation.</p>


  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Marcin  Copik.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    
    Last updated: July 20, 2021.
    
  </div>
</footer>

<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">


  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
